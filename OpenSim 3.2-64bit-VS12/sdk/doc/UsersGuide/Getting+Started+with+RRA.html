<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>OpenSim Documentation : Getting Started with RRA</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="page">
            <div id="main">
                <div id="main-header" class="pageSectionHeader">
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            OpenSim Documentation : Getting Started with RRA
                        </span>
                    </h1>

                    <div class="page-metadata">
                        <p>This page last changed on Jun 10, 2013 by <font color="#0050B2">jenhicks</font>.</p>
                    </div>
                </div>

                <div id="content" class="view">
                    <div id="main-content" class="wiki-content group">
                    <p>The purpose of residual reduction is to minimize the effects of modeling and marker data processing errors that aggregate and lead to large nonphysical compensatory forces called residuals. Specifically, residual reduction alters the torso mass center of a subject-specific model and permits the kinematics of the model from Inverse Kinematics to vary in order to be more dynamically consistent with the ground reaction force data.</p><p>The Residual Reduction Algorithm (RRA) Tool is accessed by selecting <strong>Tools → Residual Reduction Algorithm…</strong> from the OpenSim main menu bar. Like all tools, the operations performed by the Residual Reduction Algorithm Tool apply to the current model.</p><p><div>
<ul>
    <li><a href='#GettingStartedwithRRA-Overview'>Overview</a></li>
    <li><a href='#GettingStartedwithRRA-SettingsFile'>Settings File</a></li>
    <li><a href='#GettingStartedwithRRA-Inputs'>Inputs</a></li>
    <li><a href='#GettingStartedwithRRA-Outputs'>Outputs</a></li>
    <li><a href='#GettingStartedwithRRA-BestPracticesandTroubleshooting'>Best Practices and Troubleshooting</a></li>
<ul>
    <li><a href='#GettingStartedwithRRA-RRASettings'>RRA Settings:</a></li>
    <li><a href='#GettingStartedwithRRA-Troubleshooting'>Troubleshooting:</a></li>
    <li><a href='#GettingStartedwithRRA-EvaluatingyourResults'>Evaluating your Results:</a></li>
</ul>
</ul></div></p><h2 id="GettingStartedwithRRA-Overview">Overview</h2><p>The figure below shows the required inputs and outputs for performing the residual reduction algorithm. Each is described in more detail below.</p><p><img class="confluence-embedded-image" src="attachments/3376194/5046606.png" data-image-src="attachments/3376194/5046606.png"></p><p><strong>Inputs and Outputs for performing residual reduction.</strong> Experimental data are shown in <span style="color: rgb(0,204,153);">green</span>; OpenSim files (.osim) are shown in <span style="color: rgb(165,0,33);">red</span>; settings files are shown in <span style="color: rgb(51,102,255);">blue</span>; files generated by the workflow are shown in <span style="color: rgb(128,0,128);">purple</span>.</p><h2 id="GettingStartedwithRRA-SettingsFile">Settings File</h2><p>The <span style="color: rgb(51,102,255);"><strong>subject01_Setup_RRA.xml</strong></span> file is a setup file for the RRA Tool, which specifies settings, inputs, and outputs that affect the behavior of the residual reduction algorithm, which can be defined using the GUI or by hand. Details of the settings are described in the section on using the <a href="Graphical%2BUser%2BInterface.html">Graphical User Interface</a>.</p><p>The setup file identifies the actuators (i.e., the ideal residual and reserve joint actuators required by RRA) as well as the kinematic tracking tasks. Furthermore, control constraints on the actuators (to limit the maximum residual force) can be specified.</p><h2 id="GettingStartedwithRRA-Inputs">Inputs</h2><p>Several files are required as input to the RRA Tool to perform residual reduction:</p><p><span style="color: rgb(128,0,128);"><strong>subject01_walk1_ik.mot</strong></span>: Contains the time histories of model kinematics, including the joint angles and pelvis translations.</p><p><span style="color: rgb(51,102,255);"><strong>gait2345_RRA_Tasks.xml</strong></span>: A tracking tasks file specifying which coordinates to track and the corresponding tracking weight (weights are relative and determine how &quot;well&quot; a joint angle will track the specified joint angle from IK). Use this file to additionally specify any constraints on the RRA actuators. Two key considerations:</p><ol><li>Selection of kp and kv are not arbitrary; they define the behavior of the error dynamics for each q as a second-order linear system. We can write the kp and kv for the desired system behavior in terms of system poles. For a (stable) critically-damped system (real negative poles), kp = λ<sup>2</sup> and kv = -2λ.</li><li>This enables kinematics of joints (coordinates) for which we have high confidence (e.g., knee flexion, hip flexion) to be weighted more heavily compared to those of less confidence (e.g., hip internal rotation and ankle inversion).</li><li>Note that the maximum/minimum force or torque generated by an ideal actuator is the product of the maximum/minimum force and maximum/minimum excitation.</li><li>Joint torques (and muscles) have a maximum magnitude of 1.</li><li>Residuals have bounds exceeding their anticipated force requirement. Weightings are implicit in this description. A high optimal_force means that a large output force (torque) does not require a large control value (i.e., low cost). Conversely, residuals with low optimal force require high control values that incur higher costs.</li></ol><p><span style="color: rgb(0,204,153);"><strong>subject01_walk1_grf.xml</strong></span>: ExternalLoads file specifying the measured ground reaction forces that should be applied to the model during simulation and how to apply them.</p><p><span style="color: rgb(165,0,33);"><strong>subject01_simbody.osim</strong></span>: A subject-specific OpenSim model generated by scaling a generic model with the Scale Tool or by other means, along with an associated marker set containing adjusted virtual markers. The model must include inertial parameters.</p><p><span style="color: rgb(51,102,255);"><strong>gait2345_RRA_Actuators.xml</strong></span>: Ideal joint actuators used to replace muscles. The Actuator Set specifies the residual and reserve actuators to be applied and their parameters, such as maximum/minimum force and body, joint, or location (depending on the actuator type). A few key considerations:</p><ol><li>Each degree-of-freedom (DOF) in the model should have an ideal torque or force (reserve) actuator. This includes the 6 DOFs of the model's base segment, which are called the &quot;residual actuators&quot;.</li><li>In most circumstances, these ideal joint actuators are used to replace the muscles in the model (by checking &quot;Replace model actuators&quot; in the Actuators tab).</li><li>Optimal forces are the maximum output of ideal actuators (torques, linear forces). Torque (force) applied is optimal_force*control_value.</li><li>Residual at the pelvis should be applied at the scaled COM location.</li></ol><h2 id="GettingStartedwithRRA-Outputs">Outputs</h2><p>The Residual Reduction Algorithm Tool generates the following outputs:</p><p><span style="color: rgb(128,0,128);"><strong>subject01_RRA_states.sto</strong></span>: Adjusted kinematics (i.e., joint angles) and corresponding model states of the simulated motion (i.e., joint angles AND velocities).</p><p><span style="color: rgb(128,0,0);"><strong>subject01_adjusted.osim</strong></span> (optional): A model with adjusted mass properties.</p><p><span style="color: rgb(128,0,128);"><strong>subject01_RRA_controls.xml</strong></span><span style="color: rgb(0,0,255);">:</span> Actuator excitations (i.e., control signals needed to generate actuator forces and torques).</p><p><span style="color: rgb(128,0,128);"><strong>subject01_RRA_Actuation ... </strong><span style="color: rgb(0,0,0);">(not shown in figure)</span></span><span style="color: rgb(0,0,255);">:</span> Actuator forces and torques (i.e., joint torques corresponding to adjusted kinematics).</p><p><span style="color: rgb(128,0,128);"><strong><strong>subject01_RRA_Kinematics ...</strong></strong></span> (not shown in figure)<strong>: </strong>Joint angles, velocities, and accelerations</p><p><span style="color: rgb(128,0,128);"><strong><strong>subject01_RRA_avgResiduals ...</strong></strong></span> (not shown in figure)<strong>: </strong>Summary of the average residual values (FX, FY, FZ, MX, MY, MZ) for the trial</p><p><span style="color: rgb(128,0,128);"><strong><strong>subject01_RRA_Kinematics ...</strong></strong></span> (not shown in figure)<strong>: </strong>Joint angles, velocities, and accelerations</p><p><span style="color: rgb(128,0,128);"><strong><strong>subject01_RRA_pErr ...</strong></strong></span> (not shown in figure)<strong>: </strong>Position errors for each of the model's generalized coordinates during the trial</p><h2 id="GettingStartedwithRRA-BestPracticesandTroubleshooting">Best Practices and Troubleshooting</h2><p><h4 id="GettingStartedwithRRA-RRASettings">RRA Settings:</h4><ol><li>You should replace the muscles in your model with residual actuators and ideal joint actuators. Residual reduction is a form of forward dynamics simulation that utilizes a tracking controller to follow model kinematics determined from the inverse kinematics. Computed Muscle Control (CMC) serves as the controller, but without muscles, the skeleton of the model can be used to determine a mass distribution and joint kinematics that are more consistent with ground reaction forces.</li><li>Optimal forces for residuals should be low to prevent the optimizer from &quot;wanting&quot; to use residual actuators (an actuator with large optimal force and low excitation is &quot;cheap&quot; in the optimizer cost).</li><li>To help minimize residuals, make an initial pass with default inputs, then check residuals and coordinate errors. To reduce residuals further, decrease tracking weights on coordinates with low error. You can also try decreasing the maximum excitation on residuals or the actuator optimal force.</li><li>Typically, you should &quot;lock&quot; the subtalar and mtp joints in the *.osim file.</li><li>Make sure &quot;use_fast_optimization_target&quot; is false. This allows the kinematics to be slightly adjusted to account for dynamic inconsistencies. This is the default in the settings files distributed with OpenSim or created from the GUI. See <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/How+CMC+Works">How CMC Works</a> for a comparison of the &quot;slow&quot; and &quot;fast&quot; targets. In the GUI, this option is hidden for RRA and can be viewed by opening the xml settings file.</li><li>The &quot;cmc_time_window&quot; in the settings file should be 0.001 s for RRA. This is the default in the settings files distributed with OpenSim or created from the GUI.</li><li>See <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/How+RRA+Works">How RRA Works</a> and <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/How+to+Use+the+RRA+Tool">How to Use the RRA Tool</a> for more information about RRA settings.</li></ol><h4 id="GettingStartedwithRRA-Troubleshooting">Troubleshooting:</h4><ol><li>Check the pelvis COM location in the Actuator files.</li><li>If RRA is failing, try increasing the maximum excitation for residuals by orders of magnitude until the simulation runs, then try working your way back down while also &quot;relaxing&quot; tracking weights on coordinates.</li><li>If residuals are very large (typically, this is greater than 2-3 times body weight, depending on the motion), there is probably something wrong with either (i) the scaled model, (ii) the IK solution, or (iii) the applied GRFs. To double-check that forces are being applied properly, visualize GRFs with IK data (you can use the <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/Previewing+Motion+Capture+%28Mocap%29+Data">Previewing Motion Capture (Mocap) Data</a> function in the GUI).</li><li>If there is pelvis drift and/or F<sub>Y</sub> is not centered around zero, check that the body mass and force calibration are correct.</li><li><span style="color: rgb(0,0,0);">When using the example RRA Actuators .xml file, you should note that residual forces are applied to the center of mass (COM) of the unscaled pelvis; however, if you scale the model, the COM of the pelvis can change. Although the effect may be small, you should change the location of the residual force actuators in the RRA Actuators file to correspond to the scaled pelvis COM.</span></li></ol><h4 id="GettingStartedwithRRA-EvaluatingyourResults">Evaluating your Results:</h4><ol><li>RMS difference in joint angle during the movement should be less than 2-5º (or less than 2 cm for translations).</li><li>Peak residual forces should typically be less than 10-20 N. Average residuals should typically be less than 5-10 N.<br /><ol><li>The size of residuals will depend on the type of motion being studied. For example, residuals for high-speed activities like sprinting will typically be larger than walking.</li><li>Residuals will also be larger if there are external forces that you have not accounted for, such as a subject walking with a handrail.</li></ol></li><li>Compare the residual moments from RRA to the moments from Inverse Dynamics. You should see a 30-50% reduction in peak residual moments.</li><li>Compare the joint torques/forces to established literature (if available). Try to find data with multiple subjects. Your results should be within one standard deviation of the literature.</li></ol><p>The table below shows an example of threshold values used to evaluate RRA results for full-body simulations of walking and running.</p><p><img class="confluence-embedded-image confluence-content-image-border" height="183" width="511" src="attachments/3376093/3736746.png" data-image-src="attachments/3376093/3736746.png" title="RRA_Threshold_Values.PNG"></p></p><div class="panel" style="background-color: white;border-color: gray;border-style: solid;border-width: 5px;"><div class="panelContent" style="background-color: white;">
<p>Next: <a href="How%2BRRA%2BWorks.html">How RRA Works</a></p><p>Home: <a href="Residual%2BReduction%2BAlgorithm.html">Residual Reduction Algorithm</a></p>
</div></div>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/3376194/5046606.png">rra_diagram.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" style="background: url(http://simtk-confluence.stanford.edu:8080/images/border/border_bottom.gif) repeat-x;">
                <p><small>Document generated by Confluence on Feb 24, 2014 09:27</small></p>
            </div>
        </div>     </body>
</html>
